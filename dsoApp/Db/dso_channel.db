# P Prefix
# R Record root
# L Link (port)
# C Scope channel 1-4
# TPRO

# Enable/disable channel record for UI
# Don't write this value to scope right away,
# because that could happen in the middle of reading,
# and then we time out because we're trying to read
# a disabled channel
record(bo, "$(P)$(R):enable$(C)")
{
    field(ZNAM, "Off")
    field(ONAM, "On")
    field(DOL,  "1")
    field(PINI, "YES")
}

# Process chain for channel $(C):
# Write the enabled state,
# then check it and if enabled, read data
record(bo, "$(P)$(R):proc$(C)")
{
    field(TPRO, "$(TPRO)")
    field(DTYP, "stream")
    field(OMSL, "closed_loop")
    field(DOL,  "$(P)$(R):enable$(C)")
    field(OUT,  "@dso.proto enable($(C)) $(L)")
    field(ZNAM, "Off")
    field(ONAM, "On")
    field(FLNK, "$(P)$(R):enabled$(C)")
}

# Check if channel is enabled
record(bi, "$(P)$(R):enabled$(C)")
{
    field(TPRO, "$(TPRO)")
    field(INP,  "$(P)$(R):enable$(C)")
    field(ZNAM, "Off")
    field(ONAM, "On")
    field(FLNK, "$(P)$(R):info$(C)")
}

# Read info and trigger rest, but only when enabled
record(lsi, "$(P)$(R):info$(C)")
{
    field(TPRO, "$(TPRO)")
    field(SDIS, "$(P)$(R):enabled$(C)")
    field(DISV, "0")
    field(DISS, "INVALID")
    field(DTYP, "stream")
    field(INP,  "@dso.proto info($(C)) $(L)")
    field(SIZV, "100")
    field(FLNK, "$(P)$(R):ch$(C)_mult")
}

# Waveform scaling factor
record(ai, "$(P)$(R):ch$(C)_mult")
{
    field(TPRO, "$(TPRO)")
    field(DTYP, "stream")
    field(INP,  "@dso.proto mult($(C)) $(L)")
    field(FLNK, "$(P)$(R):ch$(C)_raw")
}
# Raw Waveform
record(waveform, "$(P)$(R):ch$(C)_raw")
{
    field(TPRO, "$(TPRO)")
    field(DTYP, "stream")
    field(INP,  "@dso.proto curve($(C)) $(L)")
    field(NELM, "10000")
    field(FTVL, "CHAR")
    field(FLNK, "$(P)$(R):ch$(C)_calc")
}
# Scale
record(aSub, "$(P)$(R):ch$(C)_calc")
{
    field(TPRO, "$(TPRO)")
    field(SNAM, "asub_compute_y")
    field(INPA, "$(P)$(R):ch$(C)_mult")
    field(INPB, "$(P)$(R):ch$(C)_raw")
    field(FTA,  "DOUBLE")
    field(FTB,  "CHAR")
    field(NOB,  "10000")
    field(FTVA, "DOUBLE")
    field(NOVA, "10000")
    field(FLNK, "$(P)$(R):ch$(C)")
}
# Scaled waveform
record(waveform, "$(P)$(R):ch$(C)")
{
    field(TPRO, "$(TPRO)")
    field(INP,  "$(P)$(R):ch$(C)_calc.VALA")
    field(NELM, "10000")
    field(FTVL, "DOUBLE")
    field(EGU,  "V")
    field(PREC, "6")
}
